<?xml version="1.0" encoding="UTF-8"?>
<template xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" uuid="61bee236-91b7-43fc-b08b-8bb988be21b6" xsi:noNamespaceSchemaLocation="https://www.jetbrains.com/teamcity/schemas/2021.1/project-config.xsd">
  <name>Post-build</name>
  <settings>
    <options>
      <option name="artifactRules" value="work/log =&gt; logs.zip&#xA;**/hs_err*.log =&gt; crashdumps.zip&#xA;**/core =&gt; crashdumps.zip&#xA;./**/target/rat.txt =&gt; rat.zip&#xA;/home/teamcity/ignite-startNodes/*.log =&gt; ignite-startNodes.zip&#xA;./dev-tools/IGNITE-*-*.patch =&gt; patch" />
      <option name="cleanBuild" value="true" />
    </options>
    <parameters />
    <build-runners>
      <runner id="RUNNER_266" name="Post-build cleanup" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[:<<BATCH


:: ==================== CMD =====================
@echo on
exit /b
BATCH


#  ==================== SH ======================
set -x
if %system.SKIP_BUILD%; then exit 0; fi


# Kill remaining nodes
echo "Killing CommandLineStartup processes"
for PID in $(%env.JAVA_HOME%/bin/jps | grep CommandLineStartup | awk '{ print $1 }')
do
    echo -n "    Killing remaining node process with PID ${PID}... "
    kill -9 ${PID} && echo "[OK]" || {
        echo "[ERROR] Unable to kill process ${PID}" && exit 1
    }
done
echo

# Finalize IPC cleaning
echo "Cleaning IPC resources"
for param in m s
do
    for ipcs in $(ipcs -${param} | grep 'teamcity' | awk '{ print $2 }')
    do
        ipcrm -${param} ${ipcs} || {
            echo "[ERROR] Unable to remove ${param}/${ipcs}" && exit 1
        }
    done
done
echo

# Fail build if some IPC still remains
if [ $(ipcs | grep teamcity | wc -l) -ne 0 ]
then
    echo "[ERROR] Failing build because of remaining IPC resources" >&2
    exit 1
fi

# Kill IgniteNodeRunner
echo "Killing IgniteNodeRunner processes (after tests)"
for PID in $(%env.JAVA_HOME%/bin/jps | grep IgniteNodeRunner | awk '{ print $1 }')
do
    echo -n "    Killing process with PID ${PID}... "
    kill -9 ${PID} && echo "[OK]" || {
        echo "[ERROR] Unable to kill process ${PID}" && exit 1
    }
done]]></param>
          <param name="teamcity.step.mode" value="execute_always" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
    </build-runners>
    <vcs-settings />
    <requirements />
    <build-triggers />
    <build-extensions>
      <extension id="swabra" type="swabra">
        <parameters>
          <param name="swabra.enabled" value="swabra.after.build" />
          <param name="swabra.processes" value="kill" />
          <param name="swabra.strict" value="true" />
        </parameters>
      </extension>
    </build-extensions>
    <cleanup />
  </settings>
</template>

