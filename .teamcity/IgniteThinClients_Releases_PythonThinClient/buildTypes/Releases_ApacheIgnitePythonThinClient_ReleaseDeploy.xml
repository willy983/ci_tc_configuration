<?xml version="1.0" encoding="UTF-8"?>
<build-type xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" uuid="bf228ba4-60eb-46e1-841e-30186a2b7fe0" xsi:noNamespaceSchemaLocation="https://www.jetbrains.com/teamcity/schemas/2021.1/project-config.xsd">
  <name>[2] Release Deploy</name>
  <description />
  <settings>
    <disabled-settings>
      <setting-ref ref="RUNNER_135" />
    </disabled-settings>
    <parameters />
    <build-runners>
      <runner id="RUNNER_132" name="Apply release properties" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[#!/usr/bin/env bash
set -o nounset; set -o errexit; set -o pipefail; set -o errtrace; set -o functrace
set -x


. release.properties
echo ${REVISION}
echo ${VERSION}


set +x
echo "##teamcity[setParameter name='REVISION' value='${REVISION}']"
echo "##teamcity[setParameter name='VERSION' value='${VERSION}']"]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_133" name="Deploy to PyPI" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[#!/usr/bin/env bash
set -o nounset; set -o errexit; set -o pipefail; set -o errtrace; set -o functrace
set -x


if %FLAG_DEPLOY_TO_REPOSITORY%; then
    # Publish
    twine upload -u %PYPIORG_USER% \
                 -p %PYPIORG_PASSWORD% \
                 %ARTIFACTS_DIR%/{*.tar.gz,*.whl}
fi]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_134" name="Cleanup PyPI login" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[#!/usr/bin/env bash
set -o nounset; set -o errexit; set -o pipefail; set -o errtrace; set -o functrace
set -x


if %FLAG_DEPLOY_TO_REPOSITORY%; then
    rm -rfv ~/.pypirc
fi]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_135" name="Deploy all" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[#!/usr/bin/env bash
set -o nounset; set -o errexit; set -o pipefail; set -o errtrace; set -o functrace
set -x]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_136" name="Tag released code" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[#!/usr/bin/env bash
set -o nounset; set -o errexit; set -o pipefail; set -o errtrace; set -o functrace
set -x


# Change code to built revision
if %FLAG_DEPLOY_TO_REPOSITORY%; then
    git reset %REVISION% --hard

    if [ "$(git rev-parse --verify HEAD)" == "%REVISION%" ]; then
        # Git setup
        git config --global user.name "GridGain Teamcity"
        git config --global user.email ggtc@gridgain.com

        # Git tag
        git tag -d %VERSION% || true
        git push --delete %VCS_ROOT_URL% %VERSION% || true
        git tag -a %VERSION% -m "%VERSION% release"
        git push %VCS_ROOT_URL% %VERSION%
    else
        echo "[ERROR] Unable to find revision for tagging release"
        exit 1
    fi
fi]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
    </build-runners>
    <vcs-settings>
      <vcs-entry-ref root-id="GitHubApacheIgnitePythonThinClient" />
    </vcs-settings>
    <requirements>
      <equals id="RQ_8" name="teamcity.agent.jvm.os.name" value="Linux" />
    </requirements>
    <build-triggers />
    <artifact-dependencies>
      <dependency id="ARTIFACT_DEPENDENCY_8" sourceBuildTypeId="IgniteThinClients_Releases_PythonThinClient_ReleaseBuild" cleanDestination="false">
        <revisionRule name="lastSuccessful" revision="latest.lastSuccessful" />
        <artifact sourcePath="%ARTIFACTS_DIR% =&gt; %ARTIFACTS_DIR%&#xD;&#xA;release.properties" />
      </dependency>
    </artifact-dependencies>
    <cleanup />
  </settings>
</build-type>

