<?xml version="1.0" encoding="UTF-8"?>
<template xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" uuid="cfe1405c-4630-4120-ab99-e08943ca2797" xsi:noNamespaceSchemaLocation="https://www.jetbrains.com/teamcity/schemas/2021.1/project-config.xsd">
  <name>Pre-build</name>
  <settings>
    <options>
      <option name="checkoutMode" value="ON_SERVER" />
      <option name="cleanBuild" value="true" />
    </options>
    <parameters>
      <param name="M2_REPOSITORY_DIR_LIN" value="~/.m2/repository" spec="text display='hidden' validationMode='any'" />
      <param name="M2_REPOSITORY_DIR_WIN" value="C:\.m2\repository" spec="text display='hidden' validationMode='any'" />
      <param name="env.JAVA_HOME" value="%reverse.dep.*.env.JAVA_HOME%" spec="text validationMode='any' display='hidden'" />
      <param name="reverse.dep.*.env.JAVA_HOME" value="%env.JDK_ORA_8%" spec="select data_5='%env.JDK_ORA_10%' label_5='JDK 10' label_3='JDK 9' data_7='%env.JDK_OPEN_11%' display='normal' label_7='JDK 11' description='Select JDK version for all tests' label='JDK version' data_1='%env.JDK_ORA_8%' label_1='JDK 8' data_3='%env.JDK_ORA_9%'" />
    </parameters>
    <build-runners>
      <runner id="RUNNER_264" name="Pre-build cleanup" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[:<<BATCH


:: ==================== CMD =====================
@echo on
exit /b
BATCH


#  ==================== SH ======================
set -x
if %system.SKIP_BUILD%; then exit 0; fi

# Pre-clean info
echo "User: $(whoami)"
echo "JPS (before): "
for process in $(%env.JAVA_HOME%/bin/jps)
do
    echo "    ${process}"
done
echo

# Kill processes
echo "Killing processes starters"
for processName in GridHadoopExternalProcessStarter HadoopExternalProcessStarter MainWithArgsInFile
do
    for PID in $(%env.JAVA_HOME%/bin/jps | grep ${processName} | awk '{ print $1 }')
    do
        echo -n "    Killing ${processName} process with PID ${PID}... "
        processInfo="$(ps aux -p $PID)"
        kill -9 ${PID} && echo "[OK]" || {
            echo "[ERROR] Unable to kill process ${PID}" && exit 1
        }
        echo "        Killed process info: ${processInfo}"
    done
done
echo
echo "Killing IgniteNodeRunner processes (before tests)"
for PID in $(%env.JAVA_HOME%/bin/jps | grep IgniteNodeRunner | awk '{ print $1 }')
do
    echo -n "    Killing process with PID ${PID}... "
    kill -9 ${PID} && echo "[OK]" || {
        echo "[ERROR] Unable to kill process ${PID}" && exit 1
    }
done
echo

# Post-clean info
echo "JPS (after): "
for process in $(%env.JAVA_HOME%/bin/jps)
do
    echo "    ${process}"
done
echo

# ULimit
ulimit -n 65535 && echo "Max number of OPEN FILE DESCRIPTORS:           $(ulimit -n)"
ulimit -u 65535 && echo "Max number of SINGLE USER AVAILABLE PROCESSES: $(ulimit -u)"
echo

# Finalize IPC cleaning
echo "Cleaning IPC resources"
for param in m s
do
    for ipcs in $(ipcs -${param} | grep 'teamcity' | awk '{ print $2 }')
    do
        ipcrm -${param} ${ipcs} || {
            echo "[ERROR] Unable to remove ${param}/${ipcs}" && exit 1
        }
    done
done]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_287" name="Install built artifacts to local maven repository" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[:<<BATCH


:: ==================== CMD =====================
@echo on
del /s /f /q %M2_REPOSITORY_DIR_WIN%\org\apache\ignite
md %M2_REPOSITORY_DIR_WIN%\org\apache\ignite
xcopy repository\* %M2_REPOSITORY_DIR_WIN%\org\apache\ignite\ /s
exit /b
BATCH


#  ==================== SH ======================
set -x
if %system.SKIP_BUILD%; then exit 0; fi

rm -rf %M2_REPOSITORY_DIR_LIN%/org/apache/ignite
mkdir -p %M2_REPOSITORY_DIR_LIN%/org/apache/ignite
cp -rf repository/* %M2_REPOSITORY_DIR_LIN%/org/apache/ignite/]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
    </build-runners>
    <vcs-settings>
      <vcs-entry-ref root-id="GitHubApacheIgnite" />
    </vcs-settings>
    <requirements />
    <build-triggers />
    <artifact-dependencies>
      <dependency id="ARTIFACT_DEPENDENCY_103" sourceBuildTypeId="IgniteTests24Java8_BuildApacheIgnite" cleanDestination="false">
        <revisionRule name="sameChainOrLastFinished" revision="latest.sameChainOrLastFinished" />
        <artifact sourcePath="ignite.zip!** =&gt; ./" />
      </dependency>
    </artifact-dependencies>
    <dependencies>
      <depend-on sourceBuildTypeId="IgniteTests24Java8_BuildApacheIgnite">
        <options>
          <option name="run-build-if-dependency-failed" value="CANCEL" />
          <option name="run-build-if-dependency-failed-to-start" value="CANCEL" />
          <option name="take-started-build-with-same-revisions" value="true" />
          <option name="take-successful-builds-only" value="true" />
        </options>
      </depend-on>
    </dependencies>
    <cleanup />
  </settings>
</template>

