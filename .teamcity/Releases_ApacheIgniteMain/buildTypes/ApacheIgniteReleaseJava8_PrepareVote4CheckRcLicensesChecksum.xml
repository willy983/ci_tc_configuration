<?xml version="1.0" encoding="UTF-8"?>
<build-type xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" uuid="1f67d67c-17fa-4a93-8973-5cd0f3b374d0" xsi:noNamespaceSchemaLocation="https://www.jetbrains.com/teamcity/schemas/2021.1/project-config.xsd">
  <name>[4] Check RC: Licenses, compile, chksum</name>
  <description>Run AFTER vote artifacts are uploaded to vote</description>
  <settings>
    <options>
      <option name="artifactRules" value="src/apache-ignite-%IGNITE_VERSION%-src/target/rat.txt =&gt; rat.txt" />
      <option name="cleanBuild" value="true" />
    </options>
    <disabled-settings>
      <setting-ref ref="RUNNER_236" />
    </disabled-settings>
    <parameters>
      <param name="IGNITE_VERSION" value="" spec="text description='e.g. 2.3.0' label='Ignite version' validationMode='not_empty' display='prompt'" />
      <param name="JIRA_VERSION" value="" spec="text description='e.g. 2.3' validationMode='not_empty' display='prompt'" />
      <param name="RC_NAME" value="" spec="text description='e.g. -rc1' label='RC name' validationMode='not_empty' display='prompt'" />
      <param name="env.JAVA_HOME" value="%env.JDK_ORA_8%" spec="text display='hidden' validationMode='any'" />
    </parameters>
    <build-runners>
      <runner id="RUNNER_236" name="Check Jira" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[curl "https://issues.apache.org/jira/rest/api/2/search?jql=project=ignite%%20AND%%20status%%20!=%%20closed%%20AND%%20fixVersion<=%JIRA_VERSION%&fields=summary" | grep '"total":0,"issues":\[\]'

#curl "https://issues.apache.org/jira/rest/api/2/search?jql=project=ignite%%20AND%%20status%%20!=%%20closed%%20AND%%20fixVersion<=%JIRA_VERSION%&fields=summary"]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_234" name="Download rc" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[wget -q https://dist.apache.org/repos/dist/dev/ignite/%IGNITE_VERSION%%RC_NAME%/apache-ignite-%IGNITE_VERSION%-src.zip
wget -q https://dist.apache.org/repos/dist/dev/ignite/%IGNITE_VERSION%%RC_NAME%/apache-ignite-%IGNITE_VERSION%-src.zip.asc
wget -q https://dist.apache.org/repos/dist/dev/ignite/%IGNITE_VERSION%%RC_NAME%/apache-ignite-%IGNITE_VERSION%-src.zip.sha512
wget -q https://dist.apache.org/repos/dist/dev/ignite/%IGNITE_VERSION%%RC_NAME%/apache-ignite-%IGNITE_VERSION%-bin.zip
wget -q https://dist.apache.org/repos/dist/dev/ignite/%IGNITE_VERSION%%RC_NAME%/apache-ignite-%IGNITE_VERSION%-bin.zip.asc
wget -q https://dist.apache.org/repos/dist/dev/ignite/%IGNITE_VERSION%%RC_NAME%/apache-ignite-%IGNITE_VERSION%-bin.zip.sha512


if [ ! -d scr ]; then
    mkdir src
fi

unzip -q apache-ignite-%IGNITE_VERSION%-src.zip -d src]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_235" name="Check licenses" type="Maven2">
        <parameters>
          <param name="goals" value="validate" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="pomLocation" value="src/apache-ignite-%IGNITE_VERSION%-src/pom.xml" />
          <param name="runnerArgs" value="-DskipTests=true -P check-licenses" />
          <param name="target.jdk.home" value="%env.JDK_ORA_8%" />
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="local-proxy.xml" />
        </parameters>
      </runner>
      <runner id="RUNNER_245" name="Check gpg" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[wget https://dist.apache.org/repos/dist/release/ignite/KEYS

gpg --import KEYS

ascs=$(find . -name "*.asc" -type f)

for asc in $ascs
do
    gpg --verify $asc
done]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_241" name="Check sha512" type="simpleRunner">
        <parameters>
          <param name="script.content" value="sha512sum -c *.sha512" />
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_238" name="Check source compilation" type="Maven2">
        <parameters>
          <param name="goals" value="install" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="pomLocation" value="src/apache-ignite-%IGNITE_VERSION%-src/pom.xml" />
          <param name="runnerArgs" value="-Pall-java,all-scala,ml -DskipTests=true" />
          <param name="target.jdk.home" value="%env.JDK_ORA_8%" />
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="local-proxy.xml" />
        </parameters>
      </runner>
      <runner id="RUNNER_240" name="Check Javadoc" type="Maven2">
        <parameters>
          <param name="goals" value="initialize" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="pomLocation" value="src/apache-ignite-%IGNITE_VERSION%-src/pom.xml" />
          <param name="runnerArgs" value="-DskipTests=true -Pjavadoc,ml" />
          <param name="target.jdk.home" value="%env.JDK_ORA_8%" />
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="local-proxy.xml" />
        </parameters>
      </runner>
      <runner id="RUNNER_239" name="Check Ignite build" type="Maven2">
        <parameters>
          <param name="goals" value="initialize" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="pomLocation" value="src/apache-ignite-%IGNITE_VERSION%-src/pom.xml" />
          <param name="runnerArgs" value="-DskipTests=true -Prelease,ml" />
          <param name="target.jdk.home" value="%env.JDK_ORA_8%" />
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="local-proxy.xml" />
        </parameters>
      </runner>
      <runner id="RUNNER_63" name="Check Ignite source version" type="Maven2">
        <parameters>
          <param name="goals" value="exec:exec" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="pomLocation" value="src/apache-ignite-%IGNITE_VERSION%-src/pom.xml" />
          <param name="runnerArgs" value="-Dexec.executable=test &quot;-Dexec.args=${project.version} = %IGNITE_VERSION%&quot; --non-recursive" />
          <param name="target.jdk.home" value="%env.JDK_ORA_8%" />
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="teamcity.tool.jacoco" value="%teamcity.tool.jacoco.DEFAULT%" />
          <param name="userSettingsSelection" value="local-proxy.xml" />
        </parameters>
      </runner>
    </build-runners>
    <vcs-settings />
    <requirements>
      <does-not-equal id="RQ_32" name="teamcity.agent.jvm.os.name" value="Windows 10" />
    </requirements>
    <build-triggers />
    <cleanup />
  </settings>
</build-type>

