<?xml version="1.0" encoding="UTF-8"?>
<build-type xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" uuid="1738e1c3-c1e8-48ba-bf44-6ac7768f7bd4" xsi:noNamespaceSchemaLocation="https://www.jetbrains.com/teamcity/schemas/2021.1/project-config.xsd">
  <name>-&gt; Run [#1.1] :: Apache Ignite Release Vote | Full Assembly</name>
  <description>Assemble Apache Ignite release artifacts</description>
  <settings>
    <options>
      <option name="artifactRules" value="release =&gt; release-%reverse.dep.*.IGNITE_VERSION%%reverse.dep.*.RC_NAME%.zip" />
      <option name="cleanBuild" value="true" />
    </options>
    <disabled-settings>
      <setting-ref ref="RUNNER_128" />
      <setting-ref ref="RUNNER_221" />
    </disabled-settings>
    <parameters>
      <param name="ASSEMBLY_AI" value="" spec="text display='hidden' validationMode='any'" />
      <param name="ASSEMBLY_HADOOP" value="" spec="text display='hidden' validationMode='any'" />
      <param name="env.JAVA_HOME" value="%env.JDK_ORA_8%" spec="text display='hidden' validationMode='any'" />
      <param name="reverse.dep.*.IGNITE_VERSION" value="" spec="text regexp='|[0-9|]+.|[0-9|]+.0' display='prompt' validationMessage='Version should be |'&lt;major&gt;.&lt;minor&gt;.0|'' description='Ex.: 2.4.0' label='Ignite version' validationMode='regex'" />
      <param name="reverse.dep.*.RC_NAME" value="" spec="text regexp='-rc|[0-9|]+' display='prompt' validationMessage='Release Candidate index should be |'-rc&lt;index&gt;|'' description='Ex.: -rc1' label='Release Candidate index' validationMode='regex'" />
      <param name="system.JAVA_HOME" value="%env.JAVA_HOME%" spec="text display='hidden' validationMode='any'" />
    </parameters>
    <build-runners>
      <runner id="RUNNER_218" name="Copy release scripts" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[mkdir release
cp -r ignite-release/scripts/* release/]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_216" name="Git setup (Ignore chmod settings and user/email)" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[git config core.filemode false
git config --global user.name "Ignite Teamcity"
git config --global user.email ignite@apache.org]]></param>
          <param name="teamcity.build.workingDir" value="ignite" />
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_220" name="Git patch (with changed versions) applying" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[git apply ../patch/vote.patch
git commit -a -m "version changed to: %reverse.dep.*.IGNITE_VERSION%"]]></param>
          <param name="teamcity.build.workingDir" value="ignite" />
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_229" name="Fix .git/config" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[#!/usr/bin/env bash
set -x

sed -i -r -e 's|^\[url.*||' -e 's|.*nsteadOf.*||' -e '/^$/d' ignite/.git/config]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_244" name="Zip sources" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[mkdir release/svn
mkdir release/svn/vote

cd ignite
git archive HEAD --prefix=apache-ignite-%reverse.dep.*.IGNITE_VERSION%-src/ --format=zip -o ../release/svn/vote/apache-ignite-%reverse.dep.*.IGNITE_VERSION%-src.zip]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_215" name="Save Git repo (Release tag preparation)" type="simpleRunner">
        <parameters>
          <param name="script.content" value="cp -r ignite release/git/" />
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_217" name="Create properties file" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[echo "rc_name=\"%reverse.dep.*.RC_NAME%\"" > release/release.properties
echo "ignite_version=\"%reverse.dep.*.IGNITE_VERSION%\"" >> release/release.properties]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_219" name="[TO BE REMOVED, IGNITE-6727] Install tools" type="Maven2">
        <parameters>
          <param name="goals" value="install" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="pomLocation" value="ignite/pom.xml" />
          <param name="runnerArgs" value="-pl modules/tools -am" />
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="userSettingsSelection:default" />
        </parameters>
      </runner>
      <runner id="RUNNER_221" name="Deploy Java8 (ML)" type="Maven2">
        <parameters>
          <param name="goals" value="clean deploy" />
          <param name="jvmArgs" value="-Xmx1g -XX:MaxPermSize=512m" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="pomLocation" value="ignite/pom.xml" />
          <param name="runnerArgs" value="-Pml -DskipTests -pl modules/ml -am -DaltDeploymentRepository=local::default::file:release/maven" />
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="userSettingsSelection:default" />
        </parameters>
      </runner>
      <runner id="RUNNER_222" name="Deploy All" type="Maven2">
        <parameters>
          <param name="goals" value="clean deploy" />
          <param name="jvmArgs" value="-Xmx1g -XX:MaxPermSize=512m" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="pomLocation" value="ignite/pom.xml" />
          <param name="runnerArgs" value="-Pall-java,all-scala,licenses -DclientDocs -DskipTests -DaltDeploymentRepository=local::default::file:release/maven" />
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="userSettingsSelection:default" />
        </parameters>
      </runner>
      <runner id="RUNNER_129" name="Generate javadoc" type="Maven2">
        <parameters>
          <param name="goals" value="initialize" />
          <param name="jvmArgs" value="-Xmx1g -XX:MaxPermSize=512m" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="pomLocation" value="ignite/pom.xml" />
          <param name="runnerArgs" value="-Pjavadoc" />
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="userSettingsSelection:default" />
        </parameters>
      </runner>
      <runner id="RUNNER_232" name="Copy dotnetdocs" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[cp -r dotnetdoc ignite/modules/clients/target

rm -rf dotnetdoc]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_128" name="Assembly hadoop" type="Maven2">
        <parameters>
          <param name="goals" value="initialize" />
          <param name="jvmArgs" value="-Xmx1g -XX:MaxPermSize=512m" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="pomLocation" value="ignite/pom.xml" />
          <param name="runnerArgs" value="-Prelease -Dignite.edition=apache-ignite-hadoop" />
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="userSettingsSelection:default" />
        </parameters>
      </runner>
      <runner id="RUNNER_130" name="Assembly fabric" type="Maven2">
        <parameters>
          <param name="goals" value="initialize" />
          <param name="jvmArgs" value="-Xmx1g -XX:MaxPermSize=512m" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="pomLocation" value="ignite/pom.xml" />
          <param name="runnerArgs" value="-Prelease,all-scala -Dignite.edition=apache-ignite" />
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="userSettingsSelection:default" />
        </parameters>
      </runner>
      <runner id="RUNNER_131" name="Copy binaries and make checkums" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[cp ignite/target/bin/*.* release/svn/vote

cd release/svn/vote

list=$(find . -type f -name "*.zip")

for file in $list
do
    base_name=$(basename $file)
    sha512sum $base_name > $base_name.sha512
done]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
    </build-runners>
    <vcs-settings>
      <vcs-entry-ref root-id="GitHubApacheIgniteRelease">
        <checkout-rule rule="+:. =&gt; ./ignite-release" />
      </vcs-entry-ref>
      <vcs-entry-ref root-id="GitHubApacheIgnite">
        <checkout-rule rule="+:. =&gt; ./ignite" />
      </vcs-entry-ref>
    </vcs-settings>
    <requirements>
      <contains id="RQ_26" name="teamcity.agent.jvm.os.name" value="Linux" />
    </requirements>
    <build-triggers />
    <artifact-dependencies>
      <dependency id="ARTIFACT_DEPENDENCY_99" sourceBuildTypeId="ApacheIgniteReleaseJava8_PrepareVote1NetCpp" cleanDestination="true">
        <revisionRule name="sameChainOrLastFinished" revision="latest.sameChainOrLastFinished" />
        <artifact sourcePath="ignite.dotnet.bin.zip!** =&gt; ignite/modules/platforms/dotnet/bin&#xD;&#xA;ignite.odbc.installers.zip!** =&gt; ignite/modules/platforms/cpp/bin/odbc&#xD;&#xA;dotnetdoc.zip!** =&gt; dotnetdoc&#xD;&#xA;vote.patch =&gt; patch" />
      </dependency>
    </artifact-dependencies>
    <dependencies>
      <depend-on sourceBuildTypeId="ApacheIgniteReleaseJava8_PrepareVote1NetCpp">
        <options>
          <option name="take-started-build-with-same-revisions" value="true" />
          <option name="take-successful-builds-only" value="true" />
        </options>
      </depend-on>
    </dependencies>
    <cleanup />
  </settings>
</build-type>

