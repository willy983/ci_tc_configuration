<?xml version="1.0" encoding="UTF-8"?>
<build-type xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" uuid="0a74a6dd-bb9b-4afc-be38-31aa6430ed88" xsi:noNamespaceSchemaLocation="https://www.jetbrains.com/teamcity/schemas/2021.1/project-config.xsd">
  <name>[APACHE IGNITE NIGHTLY RELEASE] #0 :: Prepare</name>
  <description />
  <settings>
    <options>
      <option name="artifactRules" value="apache-ignite-%IGNITE_VERSION%-src.zip" />
      <option name="cleanBuild" value="true" />
    </options>
    <parameters>
      <param name="IGNITE_VERSION" value="" spec="text display='hidden' validationMode='any'" />
      <param name="env.JAVA_HOME" value="%env.JDK_ORA_8%" />
    </parameters>
    <build-runners>
      <runner id="RUNNER_227" name="Generate nightly release version" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[#!/usr/bin/env bash
set -x

igniteVersion=$(cat pom.xml | \
              grep -E -m 1 '<version>[0-9]+.[0-9]+.[0-9]+(-SNAPSHOT)?</version>' | \
              sed -r 's|.*>(.*)<.*|\1|' | sed -r 's|(.*)-SNAPSHOT|\1|').$(date +%%Y%%m%%d -d "+3 hours")
echo "##teamcity[setParameter name='IGNITE_VERSION' value='${igniteVersion}']"]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_209" name="" type="simpleRunner">
        <parameters>
          <param name="script.content" value="ls -lar packaging" />
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_257" name="Change .NET &amp; C++ versions" type="Maven2">
        <parameters>
          <param name="goals" value="validate" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="runnerArgs"><![CDATA[-P update-versions
-Dnew.ignite.version=%IGNITE_VERSION%]]></param>
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="local-proxy.xml" />
        </parameters>
      </runner>
      <runner id="RUNNER_258" name="Change MAVEN version" type="Maven2">
        <parameters>
          <param name="goals" value="versions:set" />
          <param name="localRepoScope" value="mavenDefault" />
          <param name="maven.path" value="%teamcity.tool.maven.DEFAULT%" />
          <param name="runnerArgs"><![CDATA[-N
-DnewVersion=%IGNITE_VERSION%
-DgenerateBackupPoms=false
-DgroupId=*
-DartifactId=*
-DoldVersion=*]]></param>
          <param name="teamcity.coverage.emma.include.source" value="true" />
          <param name="teamcity.coverage.emma.instr.parameters" value="-ix -*Test*" />
          <param name="teamcity.coverage.idea.includePatterns" value="*" />
          <param name="teamcity.coverage.jacoco.patterns" value="+:*" />
          <param name="teamcity.step.mode" value="default" />
          <param name="userSettingsSelection" value="local-proxy.xml" />
        </parameters>
      </runner>
      <runner id="RUNNER_269" name="Change packages version" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[#!/usr/bin/env bash
set -x

sed -i -r -e '0,/Version:/s/(.*)[0-9]+\.[0-9]+.[0-9]+/\1%IGNITE_VERSION%/' \
          -e '0,/^\*/s|(.*-\ ).*(-[0-9]+.*)|\1%IGNITE_VERSION%\2|' \
    packaging/rpm/apache-ignite.spec
sed -i -r '0,/apache-ignite/s|(.*\().*(-[0-9]+\).*)|\1%IGNITE_VERSION%\2|' \
    packaging/deb/changelog]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_2" name="[HACK] Override version pattern" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[#!/usr/bin/env bash
set -x

sed -i -r -e 's|\(\\\\d\+\)\(|\(\\\\d\+\)\(\\\\.\\\\d\+\)\?\(|' \
          -e 's|match.group\(9\)|match.group(10)|' \
          -e 's|match.group\(8\)|match.group(9)|'  \
          -e 's|match.group\(7\)|match.group(8)|'  \
          -e 's|match.group\(4\)|match.group(5)|'  \
    modules/core/src/main/java/org/apache/ignite/lang/IgniteProductVersion.java]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
      <runner id="RUNNER_259" name="Prepare sources artifact" type="simpleRunner">
        <parameters>
          <param name="script.content"><![CDATA[#!/usr/bin/env bash
set -x

git config user.email "apache.ignite.tc@gmail.com"
git config user.name "Apache Ignite TeamCity"
git archive $(git stash create) --format=zip -o apache-ignite-%IGNITE_VERSION%-src.zip]]></param>
          <param name="teamcity.step.mode" value="default" />
          <param name="use.custom.script" value="true" />
        </parameters>
      </runner>
    </build-runners>
    <vcs-settings>
      <vcs-entry-ref root-id="GitHubApacheIgnite" />
    </vcs-settings>
    <requirements>
      <equals id="RQ_40" name="teamcity.agent.jvm.os.name" value="Linux" />
    </requirements>
    <build-triggers />
    <cleanup />
  </settings>
</build-type>

